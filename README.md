# Домашнее задание к занятию «SQL. Часть 2» Илларионов Дмитрий

---

Задание можно выполнить как в любом IDE, так и в командной строке.

### Задание 1

Одним запросом получите информацию о магазине, в котором обслуживается более 300 покупателей, и выведите в результат следующую информацию: 
- фамилия и имя сотрудника из этого магазина;
- город нахождения магазина;
- количество пользователей, закреплённых в этом магазине.

```
-- Одним запросом получите информацию о магазине, в котором обслуживается более 300 покупателей, и выведите в результат следующую информацию: 
-- - фамилия и имя сотрудника из этого магазина;
-- - город нахождения магазина;
-- - количество пользователей, закреплённых в этом магазине.

select s.last_name, s.first_name, c.city, scnt.cnt   from 
(
	-- количество покупателей у продавца > 300:
	select 
	 count(*) cnt,
	 s from (
	 -- перечень продавец - покупатель
			SELECT DISTINCT
			 staff_id  s,
			 customer_id c 
			FROM sakila.rental
	) sc
	group by s
	HAVING cnt >300
) scnt	
left JOIN staff s on scnt.s = s.staff_id 	
left join address a on a.address_id = s.address_id 
left join city c on c.city_id  = a.city_id; 

```

### Задание 2

Получите количество фильмов, продолжительность которых больше средней продолжительности всех фильмов.

```
-- Получите количество фильмов, продолжительность которых больше средней продолжительности всех фильмов.

select count(*)  from film 
where lENGTH > (SELECT avg(LENGTH) FROM sakila.film);
```

### Задание 3

Получите информацию, за какой месяц была получена наибольшая сумма платежей, и добавьте информацию по количеству аренд за этот месяц.


```
-- Получите информацию, за какой месяц была получена наибольшая сумма платежей, и добавьте информацию по количеству аренд за этот месяц.


select ma.month, count(*) кол_аренд
-- r.rental_id 
from
(
	 select 
		MONTH,
		sum(m.amount) s
	from (
	       SELECT DATE_FORMAT(payment_date, '%Y-%M') month, amount FROM payment
	     ) m
	group by MONTH 
	order by s DESC 
	limit 1
) ma
left join rental r 
on ma.month = DATE_FORMAT(r.rental_date , '%Y-%M')
GROUP by  ma.month;
```

## Дополнительные задания (со звёздочкой*)
Эти задания дополнительные, то есть не обязательные к выполнению, и никак не повлияют на получение вами зачёта по этому домашнему заданию. Вы можете их выполнить, если хотите глубже шире разобраться в материале.

### Задание 4*

Посчитайте количество продаж, выполненных каждым продавцом. Добавьте вычисляемую колонку «Премия». Если количество продаж превышает 8000, то значение в колонке будет «Да», иначе должно быть значение «Нет».

```
-- Посчитайте количество продаж, выполненных каждым продавцом. Добавьте вычисляемую колонку «Премия». Если количество продаж превышает 8000, то значение в колонке будет «Да», иначе должно быть значение «Нет».

SELECT  
 staff_id,
 count(*) cnt,
 CASE
    WHEN  count(*) > 8000 THEN 'yes'
	ELSE 'nor'
	END AS premia
FROM sakila.rental
group by staff_id
HAVING cnt > 8000;
```

### Задание 5*

Найдите фильмы, которые ни разу не брали в аренду.

Тут два варианта - не все фильмы есть в inventory поэтому, если нужен перечень фильмов из справочника и не важно есть ли они в инвентаризации, то, так:

```

-- Найдите фильмы, которые ни разу не брали в аренду.

select f.title 
--  i.inventory_id 
 -- ,r.rental_date 
from film f
left join inventory i on i.film_id = f.film_id 
left join rental r on r.inventory_id = i.inventory_id 
where r.rental_date is null;
```
Если же нужно только те фильмы, которые есть в инветаризации ( т.е. видимо "на складе"), то, так:

```
select f.title 
--  i.inventory_id 
 -- ,r.rental_date 
from film f
left join inventory i on i.film_id = f.film_id 
left join rental r on r.inventory_id = i.inventory_id 
where r.rental_date is null and i.inventory_id is not null;
```